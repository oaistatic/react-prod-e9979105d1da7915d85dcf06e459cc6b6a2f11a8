import{h as D,j as e,f as R,r as j,M as p,p as Se,v as ke}from"./juy90og0wtbp77qa.js";import{i4 as Pe,B as h,aC as M,hf as Te,aS as ie,g9 as Ce,lc as Ie,b3 as Ae,$ as re,e_ as ze,bX as oe,fM as Le,ak as Ee,kT as Fe,hm as Be,hb as De,gb as Re,io as Oe,dN as Ve,bW as F,bA as Ge,i5 as Je,fK as $e}from"./dc2xxjkicf2pz0mj.js";import{L as Ue,M as We,a as ee}from"./h52yy5f95o7r9b4p.js";import{hn as le,dQ as He,jx as Ke,ak as Qe,b4 as P,b3 as qe,f5 as de,b5 as Xe,bA as ce,jy as Ye}from"./ckp56qklot786ulr.js";const Ze=M.div`h-px bg-token-border-default`,v=M.div`text-sm font-medium py-3 leading-6`,et=M.div`my-4 p-5 w-full rounded-2xl popover bg-token-main-surface-primary shadow-lg border border-token-border-default`,$=":",tt=({to:t,cc:s,bcc:a,subject:n,body:i,onClick:r,isDraft:d=!0,isCanceled:o=!1})=>{const c=D(),f=[];return t&&f.push(e.jsx("div",{children:e.jsxs("div",{className:"flex",children:[e.jsxs(v,{className:"text-token-text-tertiary me-1",children:[c.formatMessage(w.draftToFieldLabel),$]}),e.jsx(v,{children:t})]})},"to")),s&&f.push(e.jsx("div",{children:e.jsxs("div",{className:"flex",children:[e.jsxs(v,{className:"text-token-text-tertiary me-1",children:[c.formatMessage(w.draftCcFieldLabel),$]}),e.jsx(v,{children:s})]})},"cc")),a&&f.push(e.jsx("div",{children:e.jsxs("div",{className:"flex",children:[e.jsxs(v,{className:"text-token-text-tertiary me-1",children:[c.formatMessage(w.draftBccFieldLabel),$]}),e.jsx(v,{children:a})]})},"bcc")),n&&f.push(e.jsx(v,{children:n},"subject")),i&&f.push(e.jsx(v,{className:"whitespace-pre-line",children:i},"body")),e.jsxs(et,{children:[e.jsxs("div",{className:"mb-4 flex items-center",children:[e.jsx(Pe,{className:"icon-sm me-4"}),e.jsx("div",{className:"font-semibold",children:d?c.formatMessage(w.draftMessageLabel):c.formatMessage(w.sentMessageLabel)})]}),f.map((_,T)=>e.jsxs(j.Fragment,{children:[e.jsx(Ze,{}),_]},T)),d&&!o&&e.jsx("div",{className:"mt-2 flex justify-end gap-4",children:e.jsx(h,{color:"primary",className:"py-2",onClick:r,children:c.formatMessage(w.sendButton)})}),o&&e.jsx("div",{className:"mt-2 flex justify-end gap-4",children:e.jsx(h,{color:"primary",className:"py-2",disabled:!0,children:c.formatMessage(w.canceledButton)})})]})},w=R({draftMessageLabel:{id:"emailView.draftMessageLabel",defaultMessage:"Draft Message"},sentMessageLabel:{id:"emailView.sentMessageLabel",defaultMessage:"Sent Message"},sendButton:{id:"emailView.sendButton",defaultMessage:"Send"},draftToFieldLabel:{id:"emailView.draftToLabel",defaultMessage:"To"},draftCcFieldLabel:{id:"emailView.draftCcLabel",defaultMessage:"Cc"},draftBccFieldLabel:{id:"emailView.draftBccLabel",defaultMessage:"Bcc"},canceledButton:{id:"emailView.canceledButton",defaultMessage:"Canceled"}});function st({action:t,handleUserAction:s,userActionParams:a,displayParams:n}){const i=Te();return t.type==="deny"?e.jsx(h,{color:"secondary",size:"small",onClick:r=>{s({sourceEvent:r,...a,actionData:{type:"deny",...t.deny}})},children:e.jsx(p,{...t.name==="decline"?b.decline:b.deny})}):t.type==="allow"?e.jsx(h,{color:"primary",size:"small",onClick:r=>{s({sourceEvent:r,...a,actionData:{type:"allow",...t.allow}})},children:e.jsx(p,{...t.name==="allow"?b.allow:b.confirm})}):t.type==="always_allow"?e.jsx(h,{color:"secondary",size:"small",onClick:r=>{s({sourceEvent:r,...a,actionData:{type:"always_allow",...t.always_allow}})},children:e.jsx(p,{...b.alwaysAllow})}):t.type==="oauth_redirect"?n.connector?e.jsx(at,{connector:n.connector,onClick:()=>{const r=ie(a.clientThreadId),d=r?new URL(le(r),window.location.origin):new URL(window.location.href);d.searchParams.set("oauth_success","true"),i({connectorId:n.connector?.id,redirectAfter:d.toString()})}}):e.jsx(h,{color:"primary",size:"small",onClick:()=>{nt(t.oauth_redirect,a.clientThreadId,a.turnGizmo)},children:e.jsx(p,{...b.signInButton,values:{domain:n.domain}})}):t.type==="contact_gizmo"?e.jsx(h,{color:"secondary",size:"small",onClick:r=>{s({sourceEvent:r,...a,actionData:{type:"contact_gizmo",...t.contact_gizmo}})},children:e.jsx(p,{...b.allow})}):null}function at({connector:t,onClick:s}){const a=D();return e.jsxs("div",{className:"flex w-80 flex-col items-center rounded-xl border p-6 text-center",children:[e.jsx(Ce,{connector:t,size:"large",className:"bg-primary shadow-xxs max-h-fit rounded-2xl border bg-clip-padding p-2"}),e.jsx("div",{className:"text-token-text-primary mt-3 text-lg font-semibold",children:Ie(t.name,a)}),e.jsx("div",{className:"text-token-text-secondary mt-1 text-sm",children:t.description}),e.jsx(h,{className:"mt-4 w-full",color:"secondary",onClick:s,children:e.jsx(p,{...b.connectButton})})]})}function nt(t,s,a){const n=Ae(s),i=ie(s),r=n?.mode?.kind===re.GizmoTest,d=i&&!r?le(i,a):window.location.href;t.gizmo_id==="FAKE_PLUGIN_GIZMO"?ze({id:t.gizmo_action_id},d):He.doOAuthRedirect(t.gizmo_id,t.gizmo_action_id,t.domain,d,r)}const b=R({alwaysAllow:{id:"jitPluginMessage.alwaysAllow",defaultMessage:"Always Allow"},allow:{id:"jitPluginMessage.allow",defaultMessage:"Allow"},decline:{id:"jitPluginMessage.decline",defaultMessage:"Decline"},confirm:{id:"jitPluginMessage.confirm",defaultMessage:"Confirm"},deny:{id:"jitPluginMessage.deny",defaultMessage:"Deny"},signInButton:{id:"jitPluginMessage.signInButton",defaultMessage:"Sign in with {domain}"},connectButton:{id:"jitPluginMessage.connectButton",defaultMessage:"Connect"}}),it=({html:t,title:s})=>{const a=j.useRef(null),n=j.useRef(!1),[i,r]=j.useState(null),[d,o]=j.useState(null);return j.useEffect(()=>{!a.current||n.current||(n.current=!0)},[]),j.useEffect(()=>{(async()=>{if(i)for await(const f of i.runHTML(t))console.log("received:",f),f.type===We.SET_INTRINSIC_HEIGHT&&o(f.intrinsicHeight)})()},[i,t]),e.jsx("iframe",{title:s,className:"no-scrollbar w-full border-none",style:{height:d?`${d}px`:"auto"},src:`${Ue}/kanzi-sandbox.html`,sandbox:"allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox",ref:a,tabIndex:-1})},rt=M.div`h-px bg-token-border-default`,te=M.div`text-sm font-medium py-3 leading-6`,ot=M.div`my-4 p-5 w-full rounded-2xl popover bg-token-main-surface-primary shadow-lg border border-token-border-default`,lt=":",dt=({functionName:t,parameters:s,onClick:a,isDraft:n=!0,isCanceled:i=!1})=>{const r=D(),d=Object.entries(s).filter(([o,c])=>!c||o==="timezone_str"&&c===Intl.DateTimeFormat().resolvedOptions().timeZone?!1:c.length>0);return e.jsxs(ot,{children:[e.jsx("div",{className:"mb-4 flex items-center font-semibold",children:e.jsx("div",{children:n?W(t):ct(t,r)})}),d.map(([o,c])=>e.jsxs("div",{children:[e.jsx(rt,{}),e.jsxs("div",{className:"flex",children:[e.jsxs(te,{className:"text-token-text-tertiary me-1",children:[W(o),lt]}),e.jsx(te,{className:"whitespace-pre-line",children:me(c,r)})]})]},o)),n&&!i&&e.jsx("div",{className:"mt-2 flex justify-end gap-4",children:e.jsx(h,{color:"primary",className:"py-2",onClick:a,children:r.formatMessage(B.approveButton)})}),i&&e.jsx("div",{className:"mt-2 flex justify-end gap-4",children:e.jsx(h,{color:"primary",className:"py-2",disabled:!0,children:r.formatMessage(B.canceledButton)})})]})},ct=(t,s)=>{switch(t){case"create_event":return"Created Event ✅";default:return`${W(t)} ${s.formatMessage(B.completedAction)} ✅`}},W=t=>{switch(t){case"timezone_str":return"Timezone";default:return t.split("_").map(s=>s.charAt(0).toUpperCase()+s.slice(1).toLowerCase()).join(" ")}},me=(t,s)=>{if(Array.isArray(t))return t.map(i=>me(i,s)).join(s.formatMessage(B.valueSeparator));if(typeof t=="object")return JSON.stringify(t);if(t.match(/^\s*\d{4}-\d{2}-\d{2}/)==null)return t;const n=new Date(t);return Number.isNaN(n.getTime())?t:s.formatDate(n,{weekday:"short",month:"short",day:"numeric",hour:"numeric",minute:"numeric"})},B=R({approveButton:{id:"ParametersView.approveButton",defaultMessage:"Approve"},completedAction:{id:"ParametersView.completedAction",defaultMessage:"Completed"},canceledButton:{id:"ParametersView.canceledButton",defaultMessage:"Canceled"},valueSeparator:{id:"ParametersView.valueSeparator",defaultMessage:","}}),ue="openaiFileIdRefs",mt=["send_email","batch_modify_email","create_event","update_event","delete_event"];function ut(t){try{return JSON.parse(t)}catch{return}}function Mt({messages:t,clientThreadId:s,isLastTurnInConversation:a,onRequestCompletion:n,useFetchConnectorPlatformConnectors:i=Be}){const[r,d]=Se();let[o,...c]=t;if(o.author.role===oe.Tool&&o.metadata?.chatgpt_sdk?.tool_call_message){const l=ut(o.metadata.chatgpt_sdk.tool_call_message);l&&(c=[o],o=l)}const f=D(),_=Le(s),T=o.metadata?.gizmo_id??_,C=Ee(s,l=>Ye(l?.mode,T)),ge=Ke(C)&&C.gizmo_id===T,I=Qe(T,ge)?.data,H=Fe(o.recipient);let O;if(H?.functionName!=null&&I?.tools!=null){for(const l of I.tools)if(xt(l,H.functionName)){O=l;break}}const pe=c.filter(l=>l.metadata?.jit_plugin_data?.from_server?.type==="debug"),V=c.filter(l=>!["debug","send_test"].some(u=>u===l.metadata?.jit_plugin_data?.from_server?.type)),{uiState:m,jitPluginData:g,fileAttachments:xe,invokedPlugin:K}=pt(o,V,a);let A;for(let l=V.length-1;l>=0;l--){const u=V[l].metadata?.jit_plugin_data;if(u?.from_server?.type==="confirm_action"){A=u;break}}let x=g?.from_server?.type!=="denied_by_user"?g?.from_server?.body.domain:O?.metadata?.domain;const he=g?.from_server?.type==="oauth_required"?g?.from_server?.body?.connector_id:void 0,Q=i(!0,De.JIT_PLUGIN).platformConnectors.get(he??"");x?x.endsWith("__jit_plugin")&&(x=x.slice(0,-12)):x="connector";const _e=O?.metadata?.privacy_policy_url;j.useEffect(()=>{if(fe(g?.from_client)?.type==="oauth_success")return;const l=r.get("oauth_success");if(g?.from_server?.type==="oauth_required"&&l){d(u=>(u.delete("oauth_success"),u),{replace:!0});for(const u of g.from_server.body.actions)if(u.type==="oauth_redirect"){U({eventSource:"url",assistantMessage:o,onRequestCompletion:n,actionData:{type:"oauth_success",target_message_id:u.oauth_redirect.target_message_id},conversationMode:C});return}}},[C,o,t,s,n,g,a,r,d]);let N=P.Running,S=x?y.running:y.starting,G={domain:x};if(m===7)return null;m===4||m===5?(N=P.Paused,S=y.confirmingSimple,G={...{gizmoName:I?.gizmo.display.name??"ChatGPT",domain:x},title:u=>e.jsxs("div",{className:"inline-flex items-center gap-1 text-sm",children:[u,e.jsx(ce,{className:"icon-sm"})]}),subtitle:u=>e.jsx("div",{className:"text-xs",children:u})}):m===1?(N=P.Finished,S=y.finished,G={domain:x}):m===2?(N=P.Error,S=y.error):(m===3||m===6)&&(N=P.Stopped,S=m===6?y.declined:y.stopped);const q={assistantMessage:o,allMessages:t,clientThreadId:s,turnGizmo:I,onRequestCompletion:n,conversationMode:C},ye={domain:x,connector:Q},X=g?.from_server?.type!=="denied_by_user"?g?.from_server?.body.actions.map((l,u)=>e.jsx(st,{action:l,displayParams:ye,handleUserAction:U,userActionParams:q},u)):null,je=S?f.formatMessage(S,G):null,ve=M.div`flex gap-2 flex-wrap mt-1 empty:hidden`,z=c[c.length-1],J=ne(g)??ne(A),Y=ht(z),be=J?.[ue]??[],we=!!J||!!Y||be.length>0;let L=e.jsx(e.Fragment,{});const E=se(g,K)??se(A,void 0)??"";if(mt.includes(E)&&(m===5||m===1||m===3||m===6)){const l=m!==1,u=(m===3||m===6)&&!a,k=ae(g,K)??ae(A,void 0),Z=Me=>{g?.from_server?.type==="confirm_action"&&g?.from_server?.body?.actions?.[0].type==="allow"&&(U({...q,sourceEvent:Me,actionData:{type:"allow",...g?.from_server?.body?.actions?.[0].allow}}),Ge(s,Ne=>{Ne.scrollToMessageId=s}))};switch(E){case"send_email":L=e.jsx(tt,{to:k?.to,cc:k?.cc,bcc:k?.bcc,subject:k?.subject,body:k?.body,onClick:m===5?Z:()=>{},isDraft:l,isCanceled:u});break;default:L=e.jsx(dt,{functionName:E??"",parameters:k??{},onClick:m===5?Z:()=>{},isDraft:l,isCanceled:u});break}}else(m===5||m===4)&&X&&(L=e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"mb-2 flex gap-2",children:X}),!Q&&e.jsxs("div",{className:"my-1 flex items-center gap-2 text-sm",children:[e.jsx(Re,{className:"icon-sm"}),e.jsx(p,{...y.confirmingSubtitle})]})]}));return e.jsxs(e.Fragment,{children:[e.jsx(gt,{debugMessages:pe}),e.jsx(qe,{highlightedCommand:je,status:N,showWorkUserSetting:!1,children:we?e.jsx(_t,{privacyPolicyUrl:_e,name:o.recipient??E,params:J,result:Y,isPromptingForPermission:N===P.Paused}):null}),e.jsx(ve,{children:xe?.map(l=>e.jsx(de,{file:l.name,fileId:l.id,width:"wide",alwaysShowData:!0,showDownloadButton:!0,downloadLink:l.download_url,contextConnectorInfo:Oe(l.context_connector_info)},l.id))}),z&&z.metadata?.chatgpt_sdk?.rendered_template&&e.jsx(it,{html:z.metadata.chatgpt_sdk.rendered_template,title:""}),L]})}function ft({messageMetadata:t}){const[s,a]=j.useState(!1);return e.jsxs("div",{className:"my-2 flex flex-col text-sm",children:[e.jsxs("div",{className:"flex flex-row items-center hover:cursor-pointer",onClick:()=>{a(!s)},children:[s?e.jsx(ce,{className:"icon-sm"}):e.jsx($e,{className:"icon-sm"}),e.jsx("div",{className:"font-semibold",children:t.display_message})]}),s&&e.jsx("pre",{children:JSON.stringify(t.data,null,2)})]})}function gt({debugMessages:t}){return t.length===0?null:e.jsx("div",{children:t.map((s,a)=>{const n=s.metadata?.jit_plugin_data?.from_server;return n&&n.type==="debug"?e.jsx(ft,{messageMetadata:n.body},a):null})})}function se(t,s){return t?.from_server?.type==="confirm_action"?t?.from_server?.body?.operation:s?.parsed_function_call?.name}function ae(t,s){return t?.from_server?.type==="confirm_action"?t?.from_server?.body?.params:s?.parsed_function_call?.kwargs}function pt(t,s,a){if(t.metadata?.jit_plugin_data?.from_server?.type==="send_test")return{uiState:7};if(s.some(n=>n.content.content_type===F.SystemError))return{uiState:2};if(Xe(t))return{uiState:3};for(let n=s.length-1;n>=0;n--){const i=s[n];if(i.metadata?.invoked_plugin){const o=[];return s.forEach(c=>{const f=c.metadata?.attachments?.filter(_=>_.display_files_from_actions_ext);f&&o.push(...f)}),{uiState:1,jitPluginData:i.metadata.jit_plugin_data,invokedPlugin:i.metadata.invoked_plugin,fileAttachments:o}}const r=fe(i.metadata?.jit_plugin_data?.from_client);if(r!=null){if(r?.type==="contact_gizmo")return{uiState:1,jitPluginData:s[n-1]?.metadata?.jit_plugin_data};if(r?.type==="deny")return{uiState:6};if(r?.type==="oauth_success")return{uiState:0,jitPluginData:i.metadata?.jit_plugin_data};break}const d=i.metadata?.jit_plugin_data?.from_server;if(d?.type==="preview"&&a)return{uiState:0,jitPluginData:i.metadata?.jit_plugin_data};if(d?.type==="confirm_action"&&a)return{uiState:5,jitPluginData:i.metadata?.jit_plugin_data};if(d?.type==="oauth_required"&&a)return{uiState:4,jitPluginData:i.metadata?.jit_plugin_data}}return{uiState:a?0:3}}function U({actionData:t,assistantMessage:s,turnGizmo:a,onRequestCompletion:n,conversationMode:i,...r}){const d={id:ke(),author:{role:oe.Tool,name:s.recipient},content:{content_type:F.Text,parts:[""]},recipient:"all",metadata:{jit_plugin_data:{from_client:t},gizmo_id:a?.gizmo.id},clientMetadata:{completionSampleFinishTime:Date.now()}};n({...r,promptMessage:d,completionMetadata:{conversationMode:i??{kind:re.PrimaryAssistant}}})}function xt(t,s){if(t.type!==Ve.JIT_PLUGIN||!t.metadata.json_schema)return!1;let a=!1;function n(i){for(const r in i)r==="operationId"&&i[r]===s&&(a=!0),i[r]&&typeof i[r]=="object"&&n(i[r])}return n(t.metadata.json_schema),a}function ne(t){if(t&&(t.from_server?.type==="confirm_action"||t.from_server?.type==="oauth_required"||t.from_server?.type==="preview"))return t.from_server.body.params}function ht(t){if(!t)return;const s=t.content.content_type===F.Text?t.content.parts[0]:t.content.content_type===F.Code?t.content.text:void 0;if(s)try{return JSON.parse(s)}catch{return s}}function _t({name:t,params:s,result:a,privacyPolicyUrl:n,isPromptingForPermission:i}){const d=(s?.[ue]??[]).map((o,c)=>{const f=o.name.startsWith("dalle-");let _=o.name;return f&&(_=`${_}.webp`),e.jsx(de,{file:_,fileId:o.id},c)});return e.jsxs("div",{className:"divide-token-border-default border-token-border-default mt-1 mb-4 divide-y overflow-hidden rounded-xl border",children:[s&&e.jsxs(e.Fragment,{children:[t&&e.jsx("div",{className:"bg-token-bg-tertiary text-token-text-secondary px-4 py-2 text-sm",children:e.jsx(p,{id:"JITPluginMessage.params.toolCall",defaultMessage:"Tool call: {name}",values:{name:e.jsx("span",{className:"text-token-text-primary",children:t})}})}),e.jsxs("div",{className:"bg-token-bg-tertiary text-token-text-secondary flex justify-between px-4 py-2 text-sm",children:[i?e.jsx(p,{id:"JITPluginMessage.params.sharing.present",defaultMessage:"The following will be shared:"}):e.jsx(p,{id:"JITPluginMessage.params.sharing.past",defaultMessage:"The following was shared:"}),n&&e.jsx("a",{href:Je(n),className:"text-token-text-primary",target:"_blank",rel:"noreferrer",children:e.jsx(p,{...y.privacyPolicyLink})})]}),e.jsx("div",{className:"px-4 py-2",children:e.jsx(ee,{value:s})}),d.length>0&&e.jsx("div",{className:"px-4 py-2",children:d})]}),a&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"bg-token-bg-tertiary text-token-text-secondary flex justify-between px-4 py-2 text-sm",children:e.jsx(p,{id:"JITPluginMessage.params.result",defaultMessage:"Result:"})}),e.jsx("div",{className:"px-4 py-2",children:e.jsx(ee,{value:a})})]})]})}function fe(t){if(t&&"user_action"in t){const s=t.user_action;t={...t,...s.data},"target_message_id"in t&&s.target_message_id&&(t.target_message_id=s.target_message_id)}return t}const y=R({starting:{id:"jitPluginMessage.starting",defaultMessage:"Starting action"},confirmingSimple:{id:"jitPluginMessage.confirming.simple",defaultMessage:"{gizmoName} wants to talk to {domain}"},confirmingSubtitle:{id:"jitPluginMessage.confirming.subtitle",defaultMessage:"Only allow sites you trust."},running:{id:"jitPluginMessage.runningV4",defaultMessage:"Talking to {domain}"},finished:{id:"jitPluginMessage.finishedV4",defaultMessage:"Talked to {domain}"},stopped:{id:"jitPluginMessage.stoppedV4",defaultMessage:"Stopped talking to {domain}"},error:{id:"jitPluginMessage.errorV5",defaultMessage:"Error talking to {domain}"},declined:{id:"jitPluginMessage.declined",defaultMessage:"You declined this action"},ranTest:{id:"jitPluginMessage.ranTest",defaultMessage:"Tested {operationName}"},confirmParamsTitle:{id:"jitPluginMessage.confirmParamsTitleV3",defaultMessage:"{gizmoName} wants to share this info with {domain}"},sentParamsTitle:{id:"jitPluginMessage.sentParamsTitleV2",defaultMessage:"{gizmoName} sent this info to {domain}"},privacyPolicyLink:{id:"jitPluginMessage.privacyPolicyLinkV2",defaultMessage:"Privacy policy"}});export{Mt as JITPluginMessage};
//# sourceMappingURL=clkzqg8ufrsooqj8.js.map
