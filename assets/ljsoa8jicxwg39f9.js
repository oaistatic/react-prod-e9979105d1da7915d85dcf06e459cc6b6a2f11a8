const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/koi0i0amwpikvw6j.js","assets/juy90og0wtbp77qa.js","assets/ckp56qklot786ulr.js","assets/dc2xxjkicf2pz0mj.js","assets/root-fv49dn40.css","assets/conversation-small-j9iamy23.css","assets/cpgn1czk8eq48vzk.js","assets/o6wb3ptvu0bk81yq.js","assets/dmfmxszxfbs8gsbx.js","assets/iacposgqe14fuloa.js","assets/o7zrzew6ugefv8n2.js","assets/abebcwj1m9mup3z6.js","assets/nqj34k5dky4x5suq.js","assets/hort3ndd4wla0a2j.js","assets/jsgl3b1bt1ozctr5.js","assets/ck00y48d3yzt8bq3.js","assets/hczymk9ojq2shlcf.js","assets/nltpzxebhe9dq1nq.js"])))=>i.map(i=>d[i]);
import{ar as F,e as me,eJ as fe,aC as ye,ay as je,bd as ke,D as re,ak as Ne,P as Ee,b2 as te,b3 as he,R as Ae,bA as Ge,bD as Pe,dX as Te,lY as De,cf as ze,b0 as Oe,C as Le,as as pe,at as xe}from"./dc2xxjkicf2pz0mj.js";import{j as n,m as K,h as V,r as a,A as He,u as ve,p as Ue}from"./juy90og0wtbp77qa.js";import{I as Z,D as Be,a as we,u as Fe}from"./l4lawytal32metvm.js";import{hG as qe,dN as $e,pr as Ke,bN as Ve,bF as B,bP as We,bR as Qe,bH as Ye,ps as Xe,pt as Je,hQ as Ze,f6 as Ie,bG as Se,hR as et,pu as I,kK as tt,pv as ne,fc as nt,pw as at,px as ce,py as st,pz as it}from"./ckp56qklot786ulr.js";import{C as _e}from"./jbze7lwlszm657iq.js";import{b as ot}from"./o6wb3ptvu0bk81yq.js";import{C as rt}from"./dsi8v49vpimk6dsy.js";import"./dta0gs41e2vxh1q9.js";import"./dmfmxszxfbs8gsbx.js";import"./aqif0rbyaiq9x43t.js";import"./kd37t55r0pqrdrzh.js";import"./f5x7owcyj5iwmbsb.js";import"./llrie03z1kvfi4vu.js";import"./jsgl3b1bt1ozctr5.js";import"./pc2givv05uuq8g6l.js";import"./dq2hdjj12gdqq0p1.js";import"./ezqsz68yx4uzdtqb.js";import"./mre9dehcylnm0d4q.js";import"./ck00y48d3yzt8bq3.js";const be=({children:e,isDimensionsUnknown:t})=>n.jsxs(K.div,{className:F(["relative max-w-[480px] rounded-2xl",t&&"aspect-square overflow-hidden"]),children:[n.jsx("div",{className:"bg-token-main-surface-secondary pointer-events-none absolute inset-0"}),n.jsx("div",{className:"relative h-full",children:e})]}),ct=({children:e,isDimensionsUnknown:t,width:s,height:i})=>n.jsxs(K.div,{layout:!0,transition:{duration:.3,ease:"easeInOut"},exit:{opacity:0,transition:{duration:.1,ease:"easeInOut"}},className:F(["relative max-w-[480px] overflow-hidden rounded-2xl",t&&"aspect-square"]),style:{width:s??"auto",height:i??"auto"},children:[n.jsx("div",{className:"bg-token-main-surface-secondary pointer-events-none absolute inset-0"}),n.jsx("div",{className:"relative h-full",children:e})]});function lt(){const[t,s]=a.useState(new Date);a.useEffect(()=>{s(new Date)},[]);const i=qe(+t,12e4);return n.jsx($e,{percentage:i,sizeOverride:30,thickness:1/15,className:"text-white",backgroundStrokeClassName:"stroke-white/20",transitionDuration:`${(100-i)/100*.2}s`,transitionTimingFunction:"cubic-bezier(0.55, 0, 1, 1)"})}const Ce=({isGettingStarted:e})=>{const t=V(),s=a.useMemo(()=>e?t.formatMessage({id:"SxQKjt",defaultMessage:"Getting started"}):t.formatMessage({id:"Y3ETLn",defaultMessage:"Creating image"}),[e,t]),i=me(),o=fe(i,"3019066937").get("should_show_cot_header",!1),l=a.useMemo(()=>e?n.jsx(_e,{size:30,arcPercentage:.2,strokeWidth:2}):n.jsx(lt,{}),[e]);return n.jsx("div",{className:F("absolute inset-0 flex items-end justify-between px-6 py-6"),children:n.jsxs(He,{mode:"popLayout",children:[o&&n.jsx(K.span,{className:F("flex items-center gap-1 align-middle text-lg",!e&&"text-white"),initial:{opacity:0},animate:{opacity:1},exit:{opacity:0,overflow:"hidden",whiteSpace:"nowrap"},transition:{duration:.1,ease:"easeInOut"},children:s},s),n.jsx("div",{className:"flex flex-1 items-center justify-end",children:l})]})})},le=ye.div`invisible absolute top-3 flex gap-1 group-hover/paragen-image:visible z-2
  ${({$rightAlign:e})=>e?"end-3":"start-3"}
  ${({$alwaysVisible:e})=>e?"visible":""}`,dt=({imageUrl:e})=>{const[t,s]=a.useState(void 0),i=V(),o=Ke(),l=a.useCallback(()=>{const r=new Date;return`${i.formatDate(r,{year:"numeric",month:"short",day:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"})}.png`},[i]);return n.jsxs("div",{className:"group/paragen-image absolute inset-0 z-3",children:[n.jsxs(le,{$alwaysVisible:!0,children:[t!==!1&&n.jsx(Z,{icon:Ve,selected:t===!0,variant:"large",onClick:r=>{r.stopPropagation(),B.paragenImageRated({liked:!0,analyticsContext:o}),s(!0)}}),t!==!0&&n.jsx(Z,{icon:We,selected:t===!1,variant:"large",onClick:r=>{r.stopPropagation(),B.paragenImageRated({liked:!1,analyticsContext:o}),s(!1)}})]}),n.jsx(le,{$alwaysVisible:!0,$rightAlign:!0,children:n.jsx(Z,{icon:Qe,variant:"large",onClick:r=>{r.stopPropagation(),B.paragenDownload({analyticsContext:o}),Ye({url:e,fileName:l()})}})})]})};function Re({withLottie:e}){const s=V().formatMessage({id:"imagegen.progressIndicator.ariaLabel",defaultMessage:"Generating image..."});return n.jsx("div",{className:"absolute start-0 top-0 flex h-full w-full items-center justify-center rounded-full","aria-label":s,children:n.jsx(_e,{size:40,arcPercentage:.2,children:n.jsx(Be,{animate:e,matchTextColor:!0,className:"h-6 w-6"})})})}const Me=300,ut=1.3,de=.05,gt=/blur\(([\d.]+)px\)/,mt={duration:Me/1e3,ease:"linear"};function ee(e,t,s){e.sort((r,c)=>r.lastSrcReceivedTime-c.lastSrcReceivedTime);const i=new Array(e.length).fill(0);for(let r=0;r<=e.length;r+=1){const c=r-1,p=r,u=e[c]?.availablePercentComplete??0,f=e[p]?.availablePercentComplete??1;if(t>=u&&t<=f&&u!==f){const _=(t-u)/(f-u);i[c]=1-_,i[p]=_}}const o=i[i.length-1],l=i[i.length-2];return o===1&&l===0&&(i[i.length-2]=.01),s&&t<=e[0]?.availablePercentComplete&&(i[0]=1),i}const ft=({alt:e,src:t,availablePercentComplete:s,onAnimationUpdate:i,ignoreFirstChunk:o=!1,isTransparent:l=!1,dimensions:r,onError:c,unconstrainedWidth:p=!1,progressLoaderProps:u})=>{const f=je(),_=a.useMemo(()=>`url(${f?Xe:Je})`,[f]),[S,C]=a.useState(!1),[v,A]=a.useState(1e3),[w,T]=a.useState(s??0),[g,b]=a.useState(s===1?1:0),N=a.useRef(performance.now()),h=a.useRef(0),x=a.useRef([]),[D,j]=a.useState([0]),[H,z]=a.useState(s===1),L=a.useRef(!1),E=a.useRef(null),k=w===1,M=s===1&&H,G=r?r.width/r.height:1;a.useEffect(()=>{!S&&s&&(C(!0),h.current=performance.now())},[S,s]),a.useEffect(()=>{const m=x.current[x.current.length-1]?.src;if(t&&t!==m){const d=x.current.findIndex(R=>R.availablePercentComplete===s);d!==-1?x.current[d]={src:t,availablePercentComplete:s??0,lastSrcReceivedTime:performance.now()}:x.current.push({src:t,availablePercentComplete:s??0,lastSrcReceivedTime:performance.now()}),j(ee(x.current,w,o))}},[t,w,o,s]);const W=a.useCallback(()=>{E.current&&s&&(A(M?Me:(performance.now()-N.current)*ut),(!o||L.current||s>=de)&&s!==1&&b(s),L.current=!0,N.current=performance.now(),u?.setHasImageReady(!0))},[s,M,o,u]),q=a.useCallback(m=>{const d=parseFloat(m.height)/100;i?.(d),T(d),j(ee(x.current,parseFloat(m.height)/100,o))},[i,o]),Q=a.useCallback(m=>{const d=m.filter.toString().match(gt)?.[1]??"0",P=(16-parseFloat(d))/16,J=1-g,Y=g+J*P;i?.(Y),T(Y),j(ee(x.current,Y,o))},[o,g,i]);if(!S)return n.jsx(be,{isDimensionsUnknown:!0,children:n.jsx(Re,{withLottie:!0})});const $={duration:v/1e3,ease:"linear"},O=s!==1||!l;return n.jsxs("div",{className:F("relative z-0 cursor-pointer overflow-hidden",G<1?"max-w-[400px]":"max-w-[480px]",!k&&"pointer-events-none",!L.current&&"bg-token-main-surface-secondary",p&&"max-w-full"),"aria-label":e,style:{aspectRatio:G},children:[!u?.shouldHideDiagonalShimmer&&s&&s<de&&n.jsx("div",{className:"absolute inset-0 z-3 w-full overflow-hidden",children:n.jsx("div",{className:"absolute start-[-150%] top-[-150%] h-[400%] w-[400%]",children:n.jsx("div",{className:"diagonal-sweep-gradient h-full w-full"})})}),n.jsxs(K.div,{className:"absolute start-0 end-0 top-0 z-2 w-full overflow-hidden transition-[mask] ease-linear",initial:M?!1:{height:"0%"},animate:k?{height:"100%"}:{height:`${g*100}%`},onUpdate:M?void 0:q,transition:M?{duration:0,ease:"linear"}:$,style:k?void 0:{mask:"linear-gradient(rgb(0,0,0) 0%, rgb(0,0,0) calc(100% - 24px), rgba(0,0,0,0) 100%)"},children:[t&&n.jsx("img",{ref:E,src:t,onLoad:W,onError:c,alt:e,className:"absolute top-0 z-1 w-full",style:{aspectRatio:G}}),l&&n.jsx("div",{className:"absolute inset-0 z-0 w-full overflow-hidden opacity-0 transition-opacity duration-300 group-hover/imagegen-image:opacity-100 group-focus/imagegen-image:opacity-100",children:n.jsx("div",{className:"absolute inset-0 bg-repeat",style:{backgroundImage:_,backgroundSize:"auto"}})})]}),n.jsx(K.div,{className:"relative z-1 w-full overflow-hidden",initial:{filter:"blur(16px)"},animate:M?{filter:"blur(0px)"}:void 0,transition:M?mt:void 0,onUpdate:M?Q:void 0,style:{aspectRatio:G},children:x.current.map((m,d)=>{const R=D[d],P=m.availablePercentComplete===1;return R!==0||P?n.jsx("img",{src:m.src,alt:e,style:{opacity:R,willChange:"opacity",aspectRatio:G},className:!M&&u?.shouldShowPulseAnimation?"bg-scale-pulse":"",onLoad:P?()=>z(!0):void 0},m.src):null})}),n.jsx(K.div,{className:"absolute inset-0 z-0 scale-110 overflow-hidden blur-2xl",style:{aspectRatio:G},children:O&&x.current.filter((m,d)=>D[d]!==0).map(m=>n.jsx("img",{src:m.src,alt:e,className:"absolute top-0 w-full"},m.src))})]})},ue=2,X=({pointer:e,altLabel:t,isEditorAvailable:s,onPercentageRendered:i,messageId:o,imageIndex:l,clientThreadId:r,serverThreadId:c,onEditorClick:p,compact:u,progressLoaderProps:f})=>{const _=ve(),[S,C]=a.useState(void 0),v=a.useRef(void 0),A=e.metadata?.generation?.gen_id,w=e.metadata?.generation?.height??void 0,T=e.height,g=(w??0)/T,b=a.useRef({}),[N]=Ue(),{isUnauthenticated:h}=ke(),[x,D]=a.useState(!1),j=a.useContext(we),H=e.width/e.height,z=Ze({imageAssetPointer:e,serverThreadId:c}),E=a.useCallback((d=!1)=>{!d&&v.current===e.asset_pointer||(v.current=e.asset_pointer,Ie.fetch(_,{asset:e,conversationId:c,force:d,isUnauthenticated:h}).then(R=>{C(R)}).finally(()=>{v.current=void 0}))},[e,_,c,h,null]);a.useEffect(()=>{const d=e.asset_pointer!==S?.asset_pointer;(!S||d)&&E()},[S,e.asset_pointer,E]);const k=a.useMemo(()=>Se({pointer:S,conversationId:c,messageId:o,source:j?"paragen":"chat",imageIndex:l.toString()}),[S,c,o,j,l]),M=a.useRef(g);a.useEffect(()=>{g===1&&M.current<1&&B.renderingComplete({analyticsContext:k})},[g,k]);const G=a.useCallback(()=>{S&&p?.({image:S,messageId:o,analyticsContext:k})},[S,o,p,k]),W=a.useMemo(()=>({width:e.width,height:e.height}),[e]),q=a.useCallback(()=>{const d=(b.current[e.asset_pointer]??0)+1;if(b.current[e.asset_pointer]=d,b.current[e.asset_pointer]>ue)return re.addAction("image-gen-asset-error",{name:"retries-exhausted",conversation_id:c,asset_pointer:e.asset_pointer,max_retries:ue});re.addAction("image-gen-asset-retry",{name:"retry-attempted",conversation_id:c,asset_pointer:e.asset_pointer,current_retry:d}),b.current[e.asset_pointer]=d,E(!0)},[e.asset_pointer,E,c]),Q=a.useCallback(d=>{d===1&&D(!0),i?.(d)},[i]),U=a.useRef(null),$=a.useRef(null);a.useEffect(()=>{if(U.current&&f?.setContainerSize){const d=U.current.getBoundingClientRect(),R={width:d.width,height:d.height},P=$.current;(!P||P.width!==R.width||P.height!==R.height)&&($.current=R,f.setContainerSize(R))}},[f]);const O=S?.url,m=z??O;return n.jsx(et.Provider,{value:k,children:n.jsxs("div",{ref:U,className:F("group/imagegen-image relative w-full overflow-hidden",H<1?"max-w-[400px]":"max-w-[480px]",u?"rounded-lg":"rounded-2xl",j&&"max-w-full",o===N.get("image")&&"[view-transition-name:var(--vt-active-image)]"),id:`image-${o}`,style:{aspectRatio:H},onClick:s?G:void 0,tabIndex:0,children:[z&&n.jsx("img",{alt:t,className:"absolute inset-0 z-1 opacity-0",src:z}),n.jsx(ft,{alt:t,src:O,availablePercentComplete:g,onAnimationUpdate:Q,isEditorAvailable:s,ignoreFirstChunk:!0,isTransparent:e.metadata?.generation?.transparent_background,dimensions:W,onError:q,unconstrainedWidth:j,progressLoaderProps:f},A),f?.state&&f?.state!==I.Complete&&!x&&f?.hasImageReady&&n.jsx(Ce,{isGettingStarted:!1}),x&&!u&&(j?n.jsx(dt,{imageUrl:O??""}):n.jsx(tt,{imageAssetPointer:O,imageUrl:m,messageId:o,clientThreadId:r,serverThreadId:c,shouldShowOverflow:z!==void 0}))]},A)})},ht=({imageGenerationState:e,isInterrupted:t,asyncMessage:s,imageAssetPointer:i,altLabel:o,clientThreadId:l,serverThreadId:r,onEditorClick:c,isEditorAvailable:p,setAnimationPercentage:u,messageId:f})=>{const[_,S]=a.useState(null),C=_==null,[v,A]=a.useState(!0),w=e===I.Thinking||e===I.AsyncGenerating&&!s?.metadata?.is_visually_hidden_from_conversation,T=e===I.Generating||e===I.Complete;return a.useEffect(()=>{w&&A(!1)},[w]),t?null:n.jsxs(n.Fragment,{children:[(w||!v)&&n.jsx(ct,{isDimensionsUnknown:C,width:_?.width,height:_?.height,children:C&&n.jsx(Ce,{isGettingStarted:!0})}),T&&n.jsx(K.div,{className:"pb-2",variants:{hidden:{opacity:0},visible:{opacity:1}},initial:"hidden",animate:v?"visible":"hidden",exit:"hidden",children:i&&n.jsx(X,{pointer:i,altLabel:o,isEditorAvailable:p,onPercentageRendered:u,messageId:f,clientThreadId:l,serverThreadId:r,imageIndex:0,onEditorClick:c,progressLoaderProps:{state:e,setContainerSize:S,hasImageReady:v,setHasImageReady:A,shouldHideDiagonalShimmer:!0,shouldShowPulseAnimation:!0}})})]})};function pt({title:e,description:t,shimmer:s}){return!e&&!t?null:n.jsxs("div",{className:"border-token-border-default my-2 max-w-[480px] min-w-72 rounded-2xl border p-6",children:[!!e&&n.jsx("p",{className:F("text-lg font-medium",s&&"loading-shimmer-pure-text-inverted",!!t&&"mb-1"),children:e}),!!t&&n.jsx("p",{children:t})]})}const xt=({cotMessages:e,visualPercentComplete:t,isInterrupted:s=!1,state:i})=>{const l=V().formatMessage({id:"imagegen.thinkingHeader.interrupted",defaultMessage:"Stopped creating image"}),r=i===I.Complete||t===1,c=a.useMemo(()=>{if(s)return l;if(!e)return;if(r)return e.complete;if(t){const p=Object.keys(e.generating);for(let u=0;u<p.length;u+=1){const f=parseFloat(p[u]);if(t<f)return e.generating[p[u]]}}else return e.thinking;return e.complete},[e,l,s,r,t]);return c&&n.jsx(rt,{latestHeadline:c,isComplete:r||s,showChunkIcon:!1,isExpandDisabled:!0})},vt=({pointersToRender:e,altLabel:t,isEditorAvailable:s,updatePercentageRendered:i,toolCallMessage:o,toolOutputMessageIds:l,clientThreadId:r,serverThreadId:c,handleEditorClick:p})=>{const u=ne.useStore(),f=ne.useSelectedIndex();a.useEffect(()=>{u.setSelectedIndex(Math.max(l.findIndex(g=>g===o?.metadata?.selected_image_message_id),0))},[]);const _=a.useRef({}),S=a.useCallback(g=>b=>{_.current[g]=b;const N=Object.keys(_.current).length,h=Object.values(_.current).reduce((x,D)=>x+D,0);i?.(h/N)},[i]),[C,v]=a.useState(null),A=Ne(r,te.getRequestId),w=nt(A);a.useEffect(()=>{!w&&C!=null&&o!=null&&c!=null&&(ge(o.id,l[C],r,c),v(null))},[w]);const T=a.useCallback(g=>{u.setSelectedIndex(g);const b=Object.values(_.current);Ee.logEventWithStatsig("chatgpt_image_switched","chatgpt_image_switched",{conversationId:c,messageId:l[g],imageIndex:g.toString(),isLoading:(b.length===0||b.some(x=>x<1)).toString()});const h=te.getConversationLastTurn(he(r))?.messages.find(x=>x.id===o?.id)!=null;o!=null&&c!=null&&(h&&w?v(g):ge(o.id,l[g],r,c))},[o,l,r,c,u,w,v]);return n.jsxs("div",{className:"flex gap-2",children:[n.jsx(X,{pointer:e[f],altLabel:t,isEditorAvailable:s,messageId:l[f],imageIndex:f,clientThreadId:r,serverThreadId:c,onEditorClick:p}),n.jsx("div",{className:"flex flex-col gap-2",children:e.map((g,b)=>n.jsx(wt,{pointer:g,altLabel:t,isSelected:b===f,onClick:()=>T(b),onPercentageRendered:g.metadata?.generation?.gen_id?S(g.metadata.generation.gen_id):void 0,messageId:l[b],imageIndex:b,clientThreadId:r,serverThreadId:c},g.metadata?.generation?.gen_id))})]})},wt=({pointer:e,altLabel:t,isSelected:s,onClick:i,onPercentageRendered:o,messageId:l,imageIndex:r,clientThreadId:c,serverThreadId:p})=>n.jsxs("button",{type:"button",onClick:i,className:"relative w-14 rounded-lg p-1",children:[n.jsx("div",{className:F(s&&"opacity-70"),children:n.jsx(X,{pointer:e,altLabel:t,isEditorAvailable:!1,onPercentageRendered:o,messageId:l,imageIndex:r,clientThreadId:c,serverThreadId:p,compact:!0})}),s&&n.jsx("div",{className:"border-token-border-default pointer-events-none absolute inset-0 rounded-xl border-2"})]});async function ge(e,t,s,i){const o=await Ae.safePost("/image-gen/message-select",{requestBody:{message_id:e,selected_image_message_id:t,conversation_id:i}}),l=o.id;l!=null&&Ge(s,r=>{Pe.updateTree(r,c=>{c.updateNodeMessage(l,o)})})}function It(e){const t=e.find(r=>r.author.role==="tool"&&r.author.name===at&&r.content.content_type==="text"),[s,...i]=t?.content.content_type==="text"?t.content.parts:[],o=i.pop(),l=i.length;return s&&o&&i.length>0?{thinking:s,complete:o,generating:i.reduce((r,c,p)=>{const u=(p+1)/l;return r[u.toFixed(2)]=c,r},{})}:void 0}const St=e=>{const t=V(),{size:s="image",count:i=1}=e||{};return i>1?{thinking:t.formatMessage({id:"cdnmKo",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"aTbInH",defaultMessage:"Creating images. May take a moment."}),"0.67":t.formatMessage({id:"WRM3Yw",defaultMessage:"Creating images. May take a moment."}),"1.00":t.formatMessage({id:"8ZydRG",defaultMessage:"Creating images. May take a moment."})},complete:t.formatMessage({id:"XQ81dl",defaultMessage:"Images created"})}:s==="xlimage"?{thinking:t.formatMessage({id:"y7op2E",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"cdrDJH",defaultMessage:"Creating image. May take a moment."}),"0.67":t.formatMessage({id:"RP4bRn",defaultMessage:"Adding details"}),"1.00":t.formatMessage({id:"o36MSQ",defaultMessage:"Finishing touches"})},complete:t.formatMessage({id:"QsnnBN",defaultMessage:"Image created"})}:{thinking:t.formatMessage({id:"6c7+kN",defaultMessage:"Getting started"}),generating:{"0.33":t.formatMessage({id:"DP6/8y",defaultMessage:"Creating image"}),"0.67":t.formatMessage({id:"k9y1TT",defaultMessage:"Creating image"}),"1.00":t.formatMessage({id:"GpR7v3",defaultMessage:"Creating image"})},complete:t.formatMessage({id:"l2Izz4",defaultMessage:"Image created"})}},_t=pe(()=>xe(()=>import("./koi0i0amwpikvw6j.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16])).then(e=>e.ImageGenConversationLightboxNew)),bt=pe(async()=>xe(()=>import("./nltpzxebhe9dq1nq.js"),__vite__mapDeps([17,3,1,4,8,2,5,7,9,10,11,12,13,14,15,16])).then(e=>e.ImageGenNewEditor)),Ct=[I.Empty,I.Errored],$t=({messages:e,clientThreadId:t,isLastTurnInConversation:s,isParagen:i=!1})=>{const o=Te(t),l=V(),r=l.formatMessage({id:"imagegen.message.altLabel",defaultMessage:"Generated image"}),[c,p]=a.useState(!1),[u,f]=a.useState(null),[_,S]=a.useState(null),{messageIds:C,imageAssetPointers:v}=a.useMemo(()=>ce(e),[e]),A=e.find(st),w=ne.useSelectedIndex(),T=v?.[w]?.metadata?.generation?.gen_size,g=St({size:T??"image",count:v?.length??1}),b=a.useMemo(()=>It(e)??g,[e,g]),N=e.find(m=>m.metadata?.image_gen_async),h=a.useMemo(()=>it(e,s),[e,s]),x=a.useRef(!1),D=a.useRef(!1),j=a.useRef(null),H=a.useMemo(()=>Se({pointer:v[w],conversationId:o,messageId:C[w],source:i?"paragen":"chat",imageIndex:w.toString()}),[v,C,w,o,i]);a.useEffect(()=>{if(!x.current&&(h===I.Thinking||h===I.Generating))x.current=!0,j.current=performance.now();else if(x.current&&!D.current)if(h===I.Complete){const m=j.current?performance.now()-j.current:void 0;B.generationSuccess({analyticsContext:H,durationMs:m}),D.current=!0}else h===I.Errored&&(B.generationFailure({analyticsContext:H,errorReason:"assistant_error"}),D.current=!0)},[h,H]);const z=e[e.length-1],L=a.useMemo(()=>z&&De(z),[z]),E=me(),k=ze(E).checkGate("3287225511"),{onRequestCompletion:M,currentModelId:G}=ot(),W=fe(E,"3019066937").get("should_use_new_ui",!1),q=Fe({clientThreadId:t})&&h===I.Complete,[Q,U]=a.useState(0),$=ve(),O=a.useCallback(async({image:m,messageId:d,analyticsContext:R})=>{if(k){const P=he(t),J=P?te.getConversationTurns(P).flatMap(y=>y.messages):e,{imageAssetPointers:Y,messageIds:ae}=ce(J,{skipSort:!0}),se=(i?[m]:await Promise.all(Y.map(y=>Ie.fetch($,{asset:y,conversationId:o})))).map((y,oe)=>({id:y.metadata?.generation?.gen_id??ae[oe],archived:!1,transformationId:y.metadata?.generation?.gen_id??null,url:y.url,assetPointer:y.asset_pointer,thumbnail:null,width:y.width,height:y.height,title:null,conversationId:o,messageId:ae[oe]}));B.editorClick({sourceOperation:m.metadata?.dalle?.edit_op??"none",analyticsContext:R});const ie=se.findIndex(y=>y.assetPointer===m.asset_pointer);Oe(E,({onClose:y})=>n.jsx(_t,{images:se,initialIndex:ie===-1?0:ie,onClose:y,onRequestCompletion:M,clientThreadId:t,currentModelId:G}))}else f(m),S(d),p(!0),B.editorClick({sourceOperation:m.metadata?.dalle?.edit_op??"none",analyticsContext:R})},[e,o,E,M,t,G,$,k,i]);return Ct.includes(h)?null:n.jsxs(we.Provider,{value:i,children:[n.jsx("div",{className:"flex flex-col",children:W?n.jsx(ht,{imageGenerationState:h,isInterrupted:L,asyncMessage:N,imageAssetPointer:v[0],altLabel:r,clientThreadId:t,serverThreadId:o,onEditorClick:O,setAnimationPercentage:U,isEditorAvailable:q,messageId:C[0]}):n.jsxs(n.Fragment,{children:[h!==I.Unavailable&&h!==I.AsyncGenerating&&h!==I.AsyncHanging&&n.jsx("div",{className:"pb-3",children:n.jsx(xt,{cotMessages:b,visualPercentComplete:Q,isInterrupted:L,state:h})}),h===I.Thinking&&!L&&n.jsx(be,{isDimensionsUnknown:!0,children:n.jsx(Re,{withLottie:!0})}),h===I.AsyncGenerating&&!N?.metadata?.is_visually_hidden_from_conversation&&n.jsx(pt,{shimmer:!0,title:N?.metadata?.ui_card_title,description:N?.metadata?.ui_card_description}),(h===I.Generating||h===I.Complete)&&!L&&n.jsx("div",{className:"pb-2",children:v.length>1?n.jsx(vt,{pointersToRender:v,altLabel:r,isEditorAvailable:q,updatePercentageRendered:U,toolCallMessage:A,toolOutputMessageIds:C,clientThreadId:t,serverThreadId:o,handleEditorClick:O}):n.jsx(X,{pointer:v[0],altLabel:r,isEditorAvailable:q,onPercentageRendered:U,messageId:C[0],imageIndex:0,clientThreadId:t,serverThreadId:o,onEditorClick:O})})]})}),!k&&n.jsx(Le,{testId:"modal-image-gen-content",type:"success",size:"fullscreen",isOpen:c,onClose:()=>p(!1),title:l.formatMessage({id:"imagegen.message.contentModalTitle",defaultMessage:"Edit image"}),visuallyHiddenHeader:!0,className:"dark:bg-(--gray-800)",children:u&&n.jsx(bt,{image:u,isLoadingNewImage:!1,clientThreadId:t,onClose:()=>p(!1),messageId:_??""})})]})};export{$t as ImageGenMessage};
//# sourceMappingURL=ljsoa8jicxwg39f9.js.map
